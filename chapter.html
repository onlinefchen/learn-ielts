<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>章节学习 - IELTS词汇</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <button onclick="window.location.href='index.html'" class="back-btn">← 返回章节列表</button>
                <h1 id="chapter-title">加载中...</h1>
            </div>
            <div class="controls">
                <select id="display-mode" class="filter-select">
                    <option value="learning">学习中</option>
                    <option value="mastered">已掌握</option>
                    <option value="all">全部</option>
                </select>
                <select id="sort-mode" class="filter-select">
                    <option value="default">默认排序</option>
                    <option value="anki">ANKI排序</option>
                </select>
                <button id="reset-chapter" class="reset-btn">重置本章进度</button>
                <div class="stats">
                    <span>总计: <strong id="total-count">0</strong></span>
                    <span>已掌握: <strong id="mastered-count">0</strong></span>
                    <span>学习中: <strong id="learning-count">0</strong></span>
                </div>
            </div>
        </header>

        <main>
            <div class="words-container" id="words-container">
                <!-- 单词卡片将通过JavaScript动态加载 -->
            </div>
        </main>
    </div>

    <script src="progress.js"></script>
    <script src="anki.js"></script>
    <script>
        let chapterName = '';
        let wordsData = [];
        let learningProgress = JSON.parse(localStorage.getItem('learningProgress') || '{}');
        let displayMode = 'learning'; // 'learning', 'mastered', 'all'
        let sortMode = 'default'; // 'default', 'anki'

        // Update function for progress manager
        window.updateUIFromProgress = function() {
            learningProgress = JSON.parse(localStorage.getItem('learningProgress') || '{}');
            displayWords();
            updateStats();
        };
        
        // Make progress globally accessible
        window.learningProgress = learningProgress;

        // 获取URL参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                chapter: params.get('chapter'),
                file: params.get('file')
            };
        }

        // 加载章节数据
        async function loadChapterData() {
            const params = getUrlParams();
            chapterName = params.chapter;
            
            try {
                const response = await fetch(`json_chapters/${params.file}`);
                const data = await response.json();
                wordsData = data.words;
                
                document.getElementById('chapter-title').textContent = data.chapter;
                displayWords();
                updateStats();
            } catch (error) {
                console.error('Error loading chapter data:', error);
            }
        }

        // 显示单词列表
        function displayWords() {
            const container = document.getElementById('words-container');
            container.innerHTML = '';
            
            const chapterProgress = learningProgress[chapterName] || {};
            
            // Prepare words with their progress data
            let wordsToDisplay = wordsData.map((word, index) => ({
                word: word,
                index: index,
                progress: chapterProgress[word.word] || null
            }));
            
            // Filter by display mode
            wordsToDisplay = wordsToDisplay.filter(item => {
                const progress = item.progress;
                if (displayMode === 'all') return true;
                if (displayMode === 'mastered') return progress && progress.mastered;
                if (displayMode === 'learning') return !progress || !progress.mastered;
                return true;
            });
            
            // Sort by selected mode
            if (sortMode === 'anki') {
                wordsToDisplay = ankiAlgorithm.sortByAnki(wordsToDisplay);
            }
            
            // Display filtered and sorted words
            wordsToDisplay.forEach(item => {
                const word = item.word;
                const index = item.index;
                const progress = item.progress;
                const isMastered = progress && progress.mastered;
                
                const wordCard = document.createElement('div');
                wordCard.className = `word-card ${isMastered ? 'mastered' : ''}`;
                wordCard.id = `word-${index}`;
                
                const reviewCount = progress ? progress.reviewCount || 0 : 0;
                const needsReview = progress && ankiAlgorithm.needsReview(progress);
                
                let wordHtml = `
                    <div class="word-header">
                        <div class="word-title-group">
                            <h3 class="word-title">
                                ${word.word}
                                <span class="word-pos">${word.pos}</span>
                                ${reviewCount > 0 ? `<span class="review-badge">复习${reviewCount}次</span>` : ''}
                                ${needsReview ? `<span class="needs-review-badge">需复习</span>` : ''}
                            </h3>
                            ${word.phonetic ? `
                            <div class="word-phonetic">
                                <span>${word.phonetic}</span>
                                <button class="speak-btn" onclick="speakWord('${word.word.replace(/'/g, "\\'")}')">
                                    🔊
                                </button>
                            </div>` : ''}
                        </div>
                        <div class="word-actions">
                            ${!isMastered ? `
                                <button class="review-btn" onclick="addReview('${word.word}', ${index})">
                                    复习 +1
                                </button>
                            ` : ''}
                            <button class="master-btn ${isMastered ? 'is-mastered' : ''}" 
                                    onclick="toggleMastered('${word.word}', ${index})">
                                ${isMastered ? '已掌握 ✓' : '标记掌握'}
                            </button>
                            ${isMastered ? `
                                <button class="relearn-btn" onclick="relearnWord('${word.word}', ${index})">
                                    重新学习
                                </button>
                            ` : ''}
                        </div>
                    </div>
                    <div class="word-content">
                        <p class="word-meaning">${word.meaning}</p>
                `;
                
                if (word.example) {
                    wordHtml += `<p class="word-example">例句: ${word.example}</p>`;
                }
                
                if (word.note) {
                    wordHtml += `<p class="word-note">笔记: ${word.note}</p>`;
                }
                
                if (word.tips) {
                    wordHtml += `<p class="word-tips">💡 记忆技巧: ${word.tips}</p>`;
                }
                
                wordHtml += '</div>';
                wordCard.innerHTML = wordHtml;
                container.appendChild(wordCard);
            });
            
            if (container.innerHTML === '') {
                let message = '';
                if (displayMode === 'learning') {
                    message = '所有单词都已掌握！切换到"全部"或"已掌握"查看。';
                } else if (displayMode === 'mastered') {
                    message = '还没有掌握任何单词。';
                } else {
                    message = '本章节暂无单词。';
                }
                container.innerHTML = `<p class="empty-message">${message}</p>`;
            }
        }

        // 添加复习次数
        function addReview(word, index) {
            if (!learningProgress[chapterName]) {
                learningProgress[chapterName] = {};
            }
            
            if (!learningProgress[chapterName][word]) {
                learningProgress[chapterName][word] = {
                    mastered: false,
                    reviewCount: 0,
                    lastReview: null,
                    nextReview: null
                };
            }
            
            const wordProgress = learningProgress[chapterName][word];
            wordProgress.reviewCount++;
            wordProgress.lastReview = new Date().toISOString();
            wordProgress.nextReview = ankiAlgorithm.getNextReviewTime(wordProgress.reviewCount);
            
            // 保存到localStorage
            localStorage.setItem('learningProgress', JSON.stringify(learningProgress));
            window.learningProgress = learningProgress;
            
            // 同步到云端
            if (window.progressManager) {
                progressManager.saveToGist(learningProgress);
            }
            
            // 更新显示
            displayWords();
            updateStats();
        }

        // 切换单词掌握状态
        function toggleMastered(word, index) {
            if (!learningProgress[chapterName]) {
                learningProgress[chapterName] = {};
            }
            
            if (!learningProgress[chapterName][word]) {
                learningProgress[chapterName][word] = {
                    mastered: false,
                    reviewCount: 0,
                    lastReview: null,
                    nextReview: null
                };
            }
            
            const wordProgress = learningProgress[chapterName][word];
            wordProgress.mastered = !wordProgress.mastered;
            wordProgress.lastReview = new Date().toISOString();
            
            if (wordProgress.mastered) {
                wordProgress.nextReview = null; // 掌握后不需要复习
            } else {
                wordProgress.nextReview = ankiAlgorithm.getNextReviewTime(wordProgress.reviewCount);
            }
            
            // 保存到localStorage
            localStorage.setItem('learningProgress', JSON.stringify(learningProgress));
            window.learningProgress = learningProgress;
            
            // 同步到云端
            if (window.progressManager) {
                progressManager.saveToGist(learningProgress);
            }
            
            // 更新显示
            displayWords();
            updateStats();
        }

        // 重新学习单词
        function relearnWord(word, index) {
            if (!learningProgress[chapterName] || !learningProgress[chapterName][word]) {
                return;
            }
            
            const wordProgress = learningProgress[chapterName][word];
            wordProgress.mastered = false;
            wordProgress.reviewCount = 0;
            wordProgress.lastReview = new Date().toISOString();
            wordProgress.nextReview = ankiAlgorithm.getNextReviewTime(0);
            
            // 保存到localStorage
            localStorage.setItem('learningProgress', JSON.stringify(learningProgress));
            window.learningProgress = learningProgress;
            
            // 同步到云端
            if (window.progressManager) {
                progressManager.saveToGist(learningProgress);
            }
            
            // 更新显示
            displayWords();
            updateStats();
        }

        // 更新统计信息
        function updateStats() {
            const chapterProgress = learningProgress[chapterName] || {};
            const stats = ankiAlgorithm.getChapterStats(chapterProgress, wordsData.length);
            
            document.getElementById('total-count').textContent = wordsData.length;
            document.getElementById('mastered-count').textContent = stats.mastered;
            document.getElementById('learning-count').textContent = stats.learning + stats.needReview + stats.new;
        }

        // 显示模式切换
        document.getElementById('display-mode').addEventListener('change', function() {
            displayMode = this.value;
            displayWords();
        });

        // 排序模式切换
        document.getElementById('sort-mode').addEventListener('change', function() {
            sortMode = this.value;
            displayWords();
        });

        // 重置本章进度
        document.getElementById('reset-chapter').addEventListener('click', function() {
            if (confirm(`确定要重置"${chapterName}"章节的所有进度吗？`)) {
                delete learningProgress[chapterName];
                localStorage.setItem('learningProgress', JSON.stringify(learningProgress));
                window.learningProgress = learningProgress;
                
                // 同步到云端
                if (window.progressManager) {
                    progressManager.saveToGist(learningProgress);
                }
                
                displayWords();
                updateStats();
            }
        });

        // TTS 发音功能
        function speakWord(word) {
            // 检查浏览器是否支持语音合成
            if ('speechSynthesis' in window) {
                // 停止当前播放的语音
                speechSynthesis.cancel();
                
                // 创建新的语音实例
                const utterance = new SpeechSynthesisUtterance(word);
                
                // 设置语音参数
                utterance.lang = 'en-US'; // 英语美音
                utterance.rate = 0.8; // 语速稍慢，便于学习
                utterance.pitch = 1; // 正常音调
                utterance.volume = 1; // 最大音量
                
                // 获取可用的语音列表
                const voices = speechSynthesis.getVoices();
                
                // 优先选择英语母语者的声音
                const englishVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && voice.localService
                ) || voices.find(voice => voice.lang.startsWith('en'));
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                // 播放语音
                speechSynthesis.speak(utterance);
                
                // 错误处理
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                };
            } else {
                alert('你的浏览器不支持语音合成功能');
            }
        }

        // 确保语音列表已加载
        function loadVoices() {
            return new Promise((resolve) => {
                let voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    speechSynthesis.onvoiceschanged = () => {
                        voices = speechSynthesis.getVoices();
                        resolve(voices);
                    };
                }
            });
        }

        // 初始化页面
        loadChapterData();
        
        // 预加载语音列表
        if ('speechSynthesis' in window) {
            loadVoices();
        }
        
        // Setup sync UI after page loads
        setTimeout(() => progressManager.setupUI(), 100);
    </script>
</body>
</html>