<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç« èŠ‚å­¦ä¹  - IELTSè¯æ±‡</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="header-nav">
                <button onclick="window.location.href='index.html'" class="back-btn">â† è¿”å›ç« èŠ‚åˆ—è¡¨</button>
                <h1 id="chapter-title">åŠ è½½ä¸­...</h1>
            </div>
            <div class="controls">
                <button id="toggle-mastered" class="toggle-btn">æ˜¾ç¤ºå·²æŒæ¡å•è¯</button>
                <button id="reset-chapter" class="reset-btn">é‡ç½®æœ¬ç« è¿›åº¦</button>
                <div class="stats">
                    <span>æ€»è®¡: <strong id="total-count">0</strong></span>
                    <span>å·²æŒæ¡: <strong id="mastered-count">0</strong></span>
                    <span>å­¦ä¹ ä¸­: <strong id="learning-count">0</strong></span>
                </div>
            </div>
        </header>

        <main>
            <div class="words-container" id="words-container">
                <!-- å•è¯å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </div>
        </main>
    </div>

    <script src="progress.js"></script>
    <script>
        let chapterName = '';
        let wordsData = [];
        let masteredWords = JSON.parse(localStorage.getItem('masteredWords') || '{}');
        let showMastered = false;

        // Update function for progress manager
        window.updateUIFromProgress = function() {
            masteredWords = JSON.parse(localStorage.getItem('masteredWords') || '{}');
            displayWords();
            updateStats();
        };

        // è·å–URLå‚æ•°
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                chapter: params.get('chapter'),
                file: params.get('file')
            };
        }

        // åŠ è½½ç« èŠ‚æ•°æ®
        async function loadChapterData() {
            const params = getUrlParams();
            chapterName = params.chapter;
            
            try {
                const response = await fetch(`json_chapters/${params.file}`);
                const data = await response.json();
                wordsData = data.words;
                
                document.getElementById('chapter-title').textContent = data.chapter;
                displayWords();
                updateStats();
            } catch (error) {
                console.error('Error loading chapter data:', error);
            }
        }

        // æ˜¾ç¤ºå•è¯åˆ—è¡¨
        function displayWords() {
            const container = document.getElementById('words-container');
            container.innerHTML = '';
            
            const chapterMastered = masteredWords[chapterName] || [];
            
            wordsData.forEach((word, index) => {
                const isMastered = chapterMastered.includes(word.word);
                
                // æ ¹æ®æ˜¾ç¤ºè®¾ç½®å†³å®šæ˜¯å¦æ˜¾ç¤ºå·²æŒæ¡å•è¯
                if (isMastered && !showMastered) {
                    return;
                }
                
                const wordCard = document.createElement('div');
                wordCard.className = `word-card ${isMastered ? 'mastered' : ''}`;
                wordCard.id = `word-${index}`;
                
                let wordHtml = `
                    <div class="word-header">
                        <div class="word-title-group">
                            <h3 class="word-title">
                                ${word.word}
                                <span class="word-pos">${word.pos}</span>
                            </h3>
                            ${word.phonetic ? `
                            <div class="word-phonetic">
                                <span>${word.phonetic}</span>
                                <button class="speak-btn" onclick="speakWord('${word.word.replace(/'/g, "\\'")}')">
                                    ğŸ”Š
                                </button>
                            </div>` : ''}
                        </div>
                        <button class="master-btn ${isMastered ? 'is-mastered' : ''}" 
                                onclick="toggleMastered('${word.word}', ${index})">
                            ${isMastered ? 'å·²æŒæ¡ âœ“' : 'æ ‡è®°æŒæ¡'}
                        </button>
                    </div>
                    <div class="word-content">
                        <p class="word-meaning">${word.meaning}</p>
                `;
                
                if (word.example) {
                    wordHtml += `<p class="word-example">ä¾‹å¥: ${word.example}</p>`;
                }
                
                if (word.note) {
                    wordHtml += `<p class="word-note">ç¬”è®°: ${word.note}</p>`;
                }
                
                if (word.tips) {
                    wordHtml += `<p class="word-tips">ğŸ’¡ è®°å¿†æŠ€å·§: ${word.tips}</p>`;
                }
                
                wordHtml += '</div>';
                wordCard.innerHTML = wordHtml;
                container.appendChild(wordCard);
            });
            
            if (container.innerHTML === '') {
                container.innerHTML = '<p class="empty-message">æ‰€æœ‰å•è¯éƒ½å·²æŒæ¡ï¼ç‚¹å‡»"æ˜¾ç¤ºå·²æŒæ¡å•è¯"æŸ¥çœ‹å…¨éƒ¨ã€‚</p>';
            }
        }

        // åˆ‡æ¢å•è¯æŒæ¡çŠ¶æ€
        function toggleMastered(word, index) {
            if (!masteredWords[chapterName]) {
                masteredWords[chapterName] = [];
            }
            
            const chapterMastered = masteredWords[chapterName];
            const wordIndex = chapterMastered.indexOf(word);
            
            if (wordIndex > -1) {
                // å–æ¶ˆæŒæ¡
                chapterMastered.splice(wordIndex, 1);
            } else {
                // æ ‡è®°ä¸ºæŒæ¡
                chapterMastered.push(word);
            }
            
            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
            
            // åŒæ­¥åˆ°äº‘ç«¯
            if (window.progressManager) {
                progressManager.saveToGist(masteredWords);
            }
            
            // æ›´æ–°æ˜¾ç¤º
            displayWords();
            updateStats();
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const chapterMastered = masteredWords[chapterName] || [];
            const totalCount = wordsData.length;
            const masteredCount = chapterMastered.length;
            const learningCount = totalCount - masteredCount;
            
            document.getElementById('total-count').textContent = totalCount;
            document.getElementById('mastered-count').textContent = masteredCount;
            document.getElementById('learning-count').textContent = learningCount;
        }

        // åˆ‡æ¢æ˜¾ç¤ºå·²æŒæ¡å•è¯
        document.getElementById('toggle-mastered').addEventListener('click', function() {
            showMastered = !showMastered;
            this.textContent = showMastered ? 'éšè—å·²æŒæ¡å•è¯' : 'æ˜¾ç¤ºå·²æŒæ¡å•è¯';
            displayWords();
        });

        // é‡ç½®æœ¬ç« è¿›åº¦
        document.getElementById('reset-chapter').addEventListener('click', function() {
            if (confirm(`ç¡®å®šè¦é‡ç½®"${chapterName}"ç« èŠ‚çš„æ‰€æœ‰è¿›åº¦å—ï¼Ÿ`)) {
                masteredWords[chapterName] = [];
                localStorage.setItem('masteredWords', JSON.stringify(masteredWords));
                displayWords();
                updateStats();
            }
        });

        // TTS å‘éŸ³åŠŸèƒ½
        function speakWord(word) {
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒè¯­éŸ³åˆæˆ
            if ('speechSynthesis' in window) {
                // åœæ­¢å½“å‰æ’­æ”¾çš„è¯­éŸ³
                speechSynthesis.cancel();
                
                // åˆ›å»ºæ–°çš„è¯­éŸ³å®ä¾‹
                const utterance = new SpeechSynthesisUtterance(word);
                
                // è®¾ç½®è¯­éŸ³å‚æ•°
                utterance.lang = 'en-US'; // è‹±è¯­ç¾éŸ³
                utterance.rate = 0.8; // è¯­é€Ÿç¨æ…¢ï¼Œä¾¿äºå­¦ä¹ 
                utterance.pitch = 1; // æ­£å¸¸éŸ³è°ƒ
                utterance.volume = 1; // æœ€å¤§éŸ³é‡
                
                // è·å–å¯ç”¨çš„è¯­éŸ³åˆ—è¡¨
                const voices = speechSynthesis.getVoices();
                
                // ä¼˜å…ˆé€‰æ‹©è‹±è¯­æ¯è¯­è€…çš„å£°éŸ³
                const englishVoice = voices.find(voice => 
                    voice.lang.startsWith('en') && voice.localService
                ) || voices.find(voice => voice.lang.startsWith('en'));
                
                if (englishVoice) {
                    utterance.voice = englishVoice;
                }
                
                // æ’­æ”¾è¯­éŸ³
                speechSynthesis.speak(utterance);
                
                // é”™è¯¯å¤„ç†
                utterance.onerror = function(event) {
                    console.error('Speech synthesis error:', event.error);
                };
            } else {
                alert('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆåŠŸèƒ½');
            }
        }

        // ç¡®ä¿è¯­éŸ³åˆ—è¡¨å·²åŠ è½½
        function loadVoices() {
            return new Promise((resolve) => {
                let voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    resolve(voices);
                } else {
                    speechSynthesis.onvoiceschanged = () => {
                        voices = speechSynthesis.getVoices();
                        resolve(voices);
                    };
                }
            });
        }

        // åˆå§‹åŒ–é¡µé¢
        loadChapterData();
        
        // é¢„åŠ è½½è¯­éŸ³åˆ—è¡¨
        if ('speechSynthesis' in window) {
            loadVoices();
        }
        
        // Setup sync UI after page loads
        setTimeout(() => progressManager.setupUI(), 100);
    </script>
</body>
</html>